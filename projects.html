<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#041833">
  <link rel="stylesheet" href="style.css">
  <title>Research Team | Projects</title>
</head>
<body>
  <header>
    <h1>Projects</h1>
    <nav>
      <a href="index.html">Home</a> |
      <a href="researchers.html">Researchers</a> |
      <a href="projects.html">Projects</a> |
      <a href="publications.html">Publications</a> |
      <a href="admin.html">Admin</a>
    </nav>
  </header>
  <main>
    <section>
      <h2>Current Initiatives</h2>
      <p class="muted">Browse active and upcoming projects. Select one to view details and slides.</p>
      <div id="project-grid" class="project-grid"></div>
    </section>
  </main>
  <script>
    const CSV_URL = 'projects.csv';

    function toSlug(value) {
      return (value || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '') || 'project';
    }

    function parseCSV(text) {
      const rows = [];
      let row = [];
      let field = '';
      let inQuotes = false;
      const cleaned = text.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');

      for (let i = 0; i < cleaned.length; i += 1) {
        const char = cleaned[i];
        const nextChar = cleaned[i + 1];

        if (char === '"') {
          if (inQuotes && nextChar === '"') {
            field += '"';
            i += 1;
          } else {
            inQuotes = !inQuotes;
          }
          continue;
        }

        if (char === ',' && !inQuotes) {
          row.push(field);
          field = '';
          continue;
        }

        if (char === '\n' && !inQuotes) {
          row.push(field);
          rows.push(row);
          row = [];
          field = '';
          continue;
        }

        field += char;
      }

      if (field.length || row.length) {
        row.push(field);
        rows.push(row);
      }

      return rows.filter(r => r.some(cell => cell.trim() !== ''));
    }

    function rowsToObjects(rows) {
      if (!rows.length) return [];
      const headers = rows[0].map(h => h.trim().toLowerCase());
      return rows.slice(1).map(row => {
        const item = {};
        headers.forEach((header, index) => {
          item[header] = (row[index] || '').trim();
        });
        return item;
      }).filter(item => item.title);
    }

    (function renderProjects() {
      const grid = document.getElementById('project-grid');

      fetch(CSV_URL, { cache: 'no-store' })
        .then(response => {
          if (!response.ok) throw new Error('Failed to load CSV');
          return response.text();
        })
        .then(text => {
          const rows = parseCSV(text);
          const projects = rowsToObjects(rows).map(item => ({
            slug: item.slug || toSlug(item.title),
            title: item.title,
            summary: item.summary || ''
          }));

          if (!projects.length) {
            grid.innerHTML = '<p class="muted">No projects available yet.</p>';
            return;
          }

          grid.innerHTML = projects.map(p => `
            <article class="project-card">
              <a class="project-card-link" href="project.html?slug=${encodeURIComponent(p.slug)}">
                <div class="project-cover">
                  <span>${p.title || 'Project'}</span>
                </div>
                <div class="project-body">
                  <h3>${p.title || 'Untitled project'}</h3>
                  <p class="muted">${p.summary || 'Details coming soon.'}</p>
                </div>
              </a>
            </article>
          `).join('');
        })
        .catch(err => {
          console.error('Failed to load projects:', err);
          grid.innerHTML = '<p class="muted">Unable to load projects. Check the CSV URL.</p>';
        });
    })();
  </script>
</body>
</html>
