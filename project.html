<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#041833">
  <link rel="stylesheet" href="style.css">
  <title>Research Team | Project</title>
</head>
<body>
  <header>
    <h1 id="project-title">Project</h1>
    <nav>
      <a href="index.html">Home</a> |
      <a href="researchers.html">Researchers</a> |
      <a href="projects.html">Projects</a> |
      <a href="publications.html">Publications</a> |
      <a href="admin.html">Admin</a>
    </nav>
  </header>
  <main id="project-main">
    <section class="project-hero">
      <div class="project-hero-image" id="project-hero-image"></div>
      <div class="project-hero-body">
        <h2 id="project-name"></h2>
        <p id="project-summary" class="muted"></p>
        <div id="project-leads" class="project-leads"></div>
        <div id="project-details" class="project-details-list"></div>
      </div>
    </section>
    <section id="project-presentations">
      <h3>Presentations</h3>
      <div id="presentations-grid" class="presentations-grid"></div>
    </section>
    <section id="project-publications">
      <h3>Related Publications</h3>
      <div id="project-publications-list" class="publications-list"></div>
    </section>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="data.js"></script>
  <script>
    (function loadProject() {
      const params = new URLSearchParams(window.location.search);
      const slug = params.get('slug');
      const heroEl = document.getElementById('project-hero-image');

      function resolvePresentationUrl(file) {
        if (!file) return '';
        if (/^(https?:)?\\/\\//.test(file) || file.startsWith('data:') || file.startsWith('/')) {
          return file;
        }
        return `presentations/${encodeURIComponent(file)}`;
      }

      function setHero(project, presentationLink) {
        heroEl.innerHTML = '';
        heroEl.classList.remove('project-cover-placeholder');
        if (project.cover) {
          const img = document.createElement('img');
          img.src = project.cover;
          img.alt = project.title || 'Project cover';
          img.onerror = () => {
            img.remove();
            heroEl.textContent = project.title || 'Project Overview';
            heroEl.classList.add('project-cover-placeholder');
          };
          if (presentationLink) {
            const link = document.createElement('a');
            link.href = presentationLink;
            link.className = 'presentation-download';
            link.appendChild(img);
            heroEl.appendChild(link);
          } else {
            heroEl.appendChild(img);
          }
        } else {
          heroEl.textContent = project.title || 'Project Overview';
          heroEl.classList.add('project-cover-placeholder');
        }
      }

      SiteData.getProjectBySlug(slug)
        .then(project => {
          if (!project) {
            document.getElementById('project-main').innerHTML = '<p class="muted">Project not found.</p>';
            document.title = 'Project not found';
            return;
          }

          document.title = project.title || 'Project';
          document.getElementById('project-title').textContent = project.title || 'Project';
          document.getElementById('project-name').textContent = project.title || 'Project';
          document.getElementById('project-summary').textContent = project.summary || '';
          const primaryPresentation = (project.presentations || [])[0];
          const presentationLink = primaryPresentation ? resolvePresentationUrl(primaryPresentation.file) : '';
          setHero(project, presentationLink);

          const leadsEl = document.getElementById('project-leads');
          leadsEl.innerHTML = '';
          (project.leads || []).forEach(lead => {
            const chip = document.createElement('a');
            chip.className = 'lead-chip';
            chip.href = `researcher.html?slug=${encodeURIComponent(lead.slug)}`;
            chip.textContent = lead.title ? `${lead.name} - ${lead.title}` : lead.name;
            leadsEl.appendChild(chip);
          });

          const detailEl = document.getElementById('project-details');
          detailEl.innerHTML = '';
          (project.details || []).forEach(item => {
            const row = document.createElement('p');
            row.textContent = item;
            detailEl.appendChild(row);
          });

          const presentationsGrid = document.getElementById('presentations-grid');
          presentationsGrid.innerHTML = '';
          if (!project.presentations || !project.presentations.length) {
            presentationsGrid.innerHTML = '<p class="muted">Presentations are being prepared. Check back soon.</p>';
          } else {
            project.presentations.forEach(presentation => {
              const card = document.createElement('article');
              card.className = 'presentation-card';
              const link = document.createElement('a');
              link.className = 'presentation-link';
              const downloadUrl = resolvePresentationUrl(presentation.file);
              if (downloadUrl) {
                link.href = downloadUrl;
                link.target = '_blank';
                link.rel = 'noreferrer';
              }
              const preview = document.createElement('div');
              preview.className = 'presentation-preview';
              if (presentation.preview) {
                const img = document.createElement('img');
                img.src = presentation.preview;
                img.alt = presentation.title || 'Presentation preview';
                img.onerror = () => img.remove();
                preview.appendChild(img);
              } else {
                preview.textContent = 'Preview coming soon';
              }
              const body = document.createElement('div');
              body.className = 'presentation-body';
              const title = document.createElement('h4');
              title.textContent = presentation.title || 'Presentation';
              const caption = document.createElement('p');
              caption.className = 'muted';
              caption.textContent = downloadUrl ? 'Download PPTX' : 'PPTX file pending';
              body.appendChild(title);
              body.appendChild(caption);
              link.appendChild(preview);
              link.appendChild(body);
              card.appendChild(link);
              presentationsGrid.appendChild(card);
            });
          }

          const publicationsList = document.getElementById('project-publications-list');
          publicationsList.innerHTML = '';
          SiteData.getPublicationsForProject(project.slug)
            .then(publications => {
              if (!publications.length) {
                publicationsList.innerHTML = '<p class="muted">We are polishing the write-up now. Publication coming soon.</p>';
                return;
              }
              publications.forEach(publication => {
                const card = document.createElement('article');
                card.className = 'publication-card';
                const title = document.createElement('h4');
                if (publication.url) {
                  const link = document.createElement('a');
                  link.href = publication.url;
                  link.textContent = publication.title || 'Publication';
                  link.target = '_blank';
                  link.rel = 'noreferrer';
                  title.appendChild(link);
                } else {
                  title.textContent = publication.title || 'Publication';
                }
                const meta = document.createElement('p');
                meta.className = 'muted';
                const parts = [];
                if (publication.researcherNames && publication.researcherNames.length) {
                  parts.push(publication.researcherNames.join(', '));
                }
                if (publication.year) {
                  parts.push(publication.year);
                }
                meta.textContent = parts.join(' â€¢ ') || 'Details coming soon.';
                card.appendChild(title);
                card.appendChild(meta);
                publicationsList.appendChild(card);
              });
            })
            .catch(err => {
              console.error('Failed to load publications:', err);
              publicationsList.innerHTML = '<p class="muted">Unable to load publications. Check the Excel file.</p>';
            });
        })
        .catch(err => {
          console.error('Failed to load project:', err);
          document.getElementById('project-main').innerHTML = '<p class="muted">Unable to load project. Check the Excel file.</p>';
        });
    })();
  </script>
</body>
</html>
