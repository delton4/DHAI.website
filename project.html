<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#041833">
  <link rel="stylesheet" href="style.css">
  <title>Research Team | Project</title>
</head>
<body>
  <header>
    <h1 id="project-title">Project</h1>
    <nav>
      <a href="index.html">Home</a> |
      <a href="researchers.html">Researchers</a> |
      <a href="projects.html">Projects</a> |
      <a href="publications.html">Publications</a> |
      <a href="admin.html">Admin</a>
    </nav>
  </header>
  <main id="project-main">
    <section class="project-hero">
      <div class="project-hero-image">
        <div id="project-cover" class="project-cover-placeholder">Project Overview</div>
      </div>
      <div class="project-hero-body">
        <h2 id="project-name"></h2>
        <p id="project-summary" class="muted"></p>
        <div id="project-leads" class="project-leads"></div>
        <div id="project-details" class="project-details-list"></div>
      </div>
    </section>
    <section id="project-slides">
      <h3>Slides</h3>
      <div id="slides-grid" class="slides-grid"></div>
    </section>
  </main>
  <script>
    const CSV_URL = 'projects.csv';

    function toSlug(value) {
      return (value || '')
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '') || 'project';
    }

    function parseCSV(text) {
      const rows = [];
      let row = [];
      let field = '';
      let inQuotes = false;
      const cleaned = text.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');

      for (let i = 0; i < cleaned.length; i += 1) {
        const char = cleaned[i];
        const nextChar = cleaned[i + 1];

        if (char === '"') {
          if (inQuotes && nextChar === '"') {
            field += '"';
            i += 1;
          } else {
            inQuotes = !inQuotes;
          }
          continue;
        }

        if (char === ',' && !inQuotes) {
          row.push(field);
          field = '';
          continue;
        }

        if (char === '\n' && !inQuotes) {
          row.push(field);
          rows.push(row);
          row = [];
          field = '';
          continue;
        }

        field += char;
      }

      if (field.length || row.length) {
        row.push(field);
        rows.push(row);
      }

      return rows.filter(r => r.some(cell => cell.trim() !== ''));
    }

    function rowsToObjects(rows) {
      if (!rows.length) return [];
      const headers = rows[0].map(h => h.trim().toLowerCase());
      return rows.slice(1).map(row => {
        const item = {};
        headers.forEach((header, index) => {
          item[header] = (row[index] || '').trim();
        });
        return item;
      }).filter(item => item.title);
    }

    function splitList(value) {
      return (value || '')
        .split('|')
        .map(item => item.trim())
        .filter(Boolean);
    }

    function parseLeads(value) {
      return splitList(value).map(entry => {
        const parts = entry.split('::').map(part => part.trim());
        return {
          name: parts[0] || '',
          title: parts[1] || '',
          slug: toSlug(parts[0] || '')
        };
      }).filter(lead => lead.name);
    }

    function parseSlides(value) {
      return splitList(value).map(entry => {
        const parts = entry.split('::').map(part => part.trim());
        return {
          title: parts[0] || '',
          caption: parts[1] || ''
        };
      }).filter(slide => slide.title);
    }

    (function loadProject() {
      const params = new URLSearchParams(window.location.search);
      const slug = params.get('slug');
      fetch(CSV_URL, { cache: 'no-store' })
        .then(response => {
          if (!response.ok) throw new Error('Failed to load CSV');
          return response.text();
        })
        .then(text => {
          const rows = parseCSV(text);
          const projects = rowsToObjects(rows).map(item => ({
            slug: item.slug || toSlug(item.title),
            title: item.title,
            summary: item.summary || '',
            leads: parseLeads(item.leads),
            details: splitList(item.details),
            slides: parseSlides(item.slides)
          }));

          const project = projects.find(p => p.slug === slug) || projects[0];
          if (!project) {
            document.getElementById('project-main').innerHTML = '<p class="muted">Project not found.</p>';
            document.title = 'Project not found';
            return;
          }

          document.title = project.title || 'Project';
          document.getElementById('project-title').textContent = project.title || 'Project';
          document.getElementById('project-name').textContent = project.title || 'Project';
          document.getElementById('project-summary').textContent = project.summary || '';
          document.getElementById('project-cover').textContent = project.title || 'Project Overview';

          const leadsEl = document.getElementById('project-leads');
          leadsEl.innerHTML = '';
          (project.leads || []).forEach(lead => {
            const chip = document.createElement('a');
            chip.className = 'lead-chip';
            chip.href = `researcher.html?slug=${encodeURIComponent(lead.slug)}`;
            chip.textContent = lead.title ? `${lead.name} - ${lead.title}` : lead.name;
            leadsEl.appendChild(chip);
          });

          const detailEl = document.getElementById('project-details');
          detailEl.innerHTML = '';
          (project.details || []).forEach(item => {
            const row = document.createElement('p');
            row.textContent = item;
            detailEl.appendChild(row);
          });

          const slidesGrid = document.getElementById('slides-grid');
          slidesGrid.innerHTML = '';
          if (!project.slides || !project.slides.length) {
            slidesGrid.innerHTML = '<p class="muted">Slides will appear here when available.</p>';
          } else {
            project.slides.forEach(slide => {
              const card = document.createElement('article');
              card.className = 'slide-card';
              const body = document.createElement('div');
              body.className = 'slide-body';
              const title = document.createElement('h4');
              title.textContent = slide.title || 'Slide';
              const caption = document.createElement('p');
              caption.className = 'muted';
              caption.textContent = slide.caption || '';
              body.appendChild(title);
              body.appendChild(caption);
              card.appendChild(body);
              slidesGrid.appendChild(card);
            });
          }
        })
        .catch(err => {
          console.error('Failed to load projects:', err);
          document.getElementById('project-main').innerHTML = '<p class="muted">Unable to load project. Check the CSV URL.</p>';
        });
    })();
  </script>
</body>
</html>
